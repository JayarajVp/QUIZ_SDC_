<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="quiz-container">
        <h2 id="timer">Time Left: 40s</h2>
        <div id="question-container">
            <h3 id="question"></h3>
            <div id="options"></div>
        </div>
        <button id="next-button" disabled>Next</button>
        <div id="result" style="display: none;">
            <h2>Quiz Finished!</h2>
            <p id="score"></p>
            <p id="total-time"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCXUOurYSr1T7hgio8L2JF_-3Odg8vutUg",
            authDomain: "quiz-fb5d9.firebaseapp.com",
            projectId: "quiz-fb5d9",
            storageBucket: "quiz-fb5d9.appspot.com",
            messagingSenderId: "916039221761",
            appId: "1:916039221761:web:df2104737062375b3ff600",
            measurementId: "G-BPTGDJXS8K"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Initialize quiz variables
        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let timer;
        const timePerQuestion = 40; // 40 seconds for each question
        let totalTime = 0;

        // Get username from localStorage
        const username = localStorage.getItem("username");

        // Load questions from Firebase
        function loadQuestions() {
            const questionsRef = ref(db, 'questions/');
            onValue(questionsRef, (snapshot) => {
                questions = Object.values(snapshot.val());
                startQuiz();
            });
        }

        // Start the quiz
        function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            totalTime = 0;
            document.getElementById('result').style.display = 'none';
            document.getElementById('next-button').disabled = false;
            loadQuestion();
        }

        // Load the current question
        function loadQuestion() {
            if (currentQuestionIndex < questions.length) {
                const questionData = questions[currentQuestionIndex];
                document.getElementById('question').innerText = questionData.question;

                // Display options
                const optionsContainer = document.getElementById('options');
                optionsContainer.innerHTML = ''; // Clear previous options
                Object.values(questionData.options).forEach((option, index) => {
                    const button = document.createElement('button');
                    button.innerText = option;
                    button.classList.add('option-button');
                    button.addEventListener('click', () => selectAnswer(option, questionData.correctOption));
                    optionsContainer.appendChild(button);
                });

                // Start timer
                startTimer(timePerQuestion);
            } else {
                finishQuiz();
            }
        }

        // Handle answer selection
        function selectAnswer(selectedOption, correctOption) {
            clearInterval(timer); // Stop the timer
            if (selectedOption === correctOption) {
                score++;
            }
            totalTime += timePerQuestion; // Add to total time
            currentQuestionIndex++;
            loadQuestion();
        }

        // Start timer for each question
        function startTimer(seconds) {
            let timeLeft = seconds;
            document.getElementById('timer').innerText = `Time Left: ${timeLeft}s`;

            timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = `Time Left: ${timeLeft}s`;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    totalTime += seconds; // Add time to total
                    currentQuestionIndex++;
                    loadQuestion(); // Move to the next question
                }
            }, 1000);
        }

        // Finish quiz and display results
        function finishQuiz() {
            document.getElementById('question-container').style.display = 'none';
            document.getElementById('next-button').style.display = 'none';
            document.getElementById('result').style.display = 'block';
            document.getElementById('score').innerText = `Your final score: ${score} out of ${questions.length}`;
            document.getElementById('total-time').innerText = `Total Time Taken: ${totalTime} seconds`;

            // Store result in database
            storeResult();
        }

        // Store result in Firebase
        function storeResult() {
            const resultData = {
                username: username,
                score: score,
                totalTime: totalTime
            };
            const userRef = ref(db, 'user/' + username);
            userRef.update({ result: resultData })
                .then(() => console.log("Result saved successfully"))
                .catch((error) => console.error("Error saving result:", error));
        }

        // Start loading questions
        loadQuestions();
    </script>
</body>
</html>
